<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>프로필 설정</title>
  <link rel="stylesheet" href="profile.css" />
</head>
<body>
  <main class="phone">
    <!-- 상태바 -->
    <header class="statusbar" role="banner">
      <span class="sb-time">9:41</span>
      <div class="sb-icons" aria-hidden="true">
        <img src="../assets/images/cellular.svg" alt="">
        <img src="../assets/images/wifi.svg" alt="">
        <img src="../assets/images/battery.svg" alt="">
      </div>
    </header>

    <!-- 상단 로고 / 역할 -->
    <div class="top">
        <div class="brand">
          <img src="../assets/icons/logo.svg" alt="안녕 로고">
        </div>
      
        <div class="top-actions">
          <button type="button" class="icon-btn" id="btnLang" aria-label="언어 설정">
            <img src="../assets/icons/lang.svg" alt="" aria-hidden="true">
          </button>
          <button type="button" class="icon-btn" id="btnNotify" aria-label="알림">
            <img src="../assets/icons/user.svg" alt="" aria-hidden="true">
            <!-- 필요하면 알림 점 -->
            <!-- <span class="dot" aria-hidden="true"></span> -->
          </button>
          <button type="button" class="icon-btn" id="btnProfile" aria-label="내 프로필">
            <img src="../assets/icons/message.svg" alt="" aria-hidden="true">
          </button>
        </div>
      </div>

    <!-- 전체 카드 -->
    <form class="profile-form" action="#" method="post" novalidate>
      <section class="profile-card" aria-label="프로필 카드">
        <button class="vc-close" type="button" aria-label="닫기">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>

        <!-- 인증 배너 -->
        <div class="verify-banner">
          <div class="vb-head">
            <img class="g-logo" src="../assets/icons/google-g.svg" alt="">
            <div class="vb-texts">
              <p class="vb-title">프로필 인증뱃지 <span class="badge" aria-label="인증됨">✔︎</span></p>
              <p class="vb-sub">구글 계정 연동하면 인증뱃지를 받을 수 있어요!</p>
            </div>
          </div>
          <button type="button" class="btn-ghost" id="googleConnectBtn">소셜 로그인 연결하기</button>
        </div>

        <!-- 아바타 -->
        <div class="avatar-wrap">
          <div class="avatar">
            <!-- 나중에 이미지 교체 -->
            <img src="../assets/images/profile-sample.png" alt="프로필 이미지">
            <span class="tick">
                <img class="badge-img" src="../assets/images/verified-badge.svg" alt="인증됨">
              </span>
          </div>
          <a href="#" class="edit-photo">사진 수정하기
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 21h6l12-12-6-6L3 15v6zM14 6l4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>

        <hr class="card-sep" aria-hidden="true" />

        <!-- 입력 섹션 -->
        <div class="card-body">
          <!-- 이름(표시) -->
          <div class="input-group">
            <label for="real_name" class="input-label">이름</label>
            <div class="field">
              <input id="real_name" type="text" placeholder="이름을 입력해주세요." />
            </div>
          </div>

          <!-- 나이 -->
          <div class="input-group">
            <label for="age" class="input-label">나이</label>
            <div class="field">
              <input id="age" type="number" inputmode="numeric" placeholder="나이를 입력해주세요." min="1" />
            </div>
          </div>

          <!-- 국가 -->
          <div class="input-group">
            <label for="country" class="input-label">국가</label>
            <div class="field select-field">
              <select id="country">
                <option value="" selected>국가선택하기</option>
                <option value="kr">대한민국</option>
                <option value="jp">일본</option>
                <option value="us">미국</option>
                <option value="cn">중국</option>
                <option value="vn">베트남</option>
                <option value="th">태국</option>
                <option value="ru">러시아</option>
                <option value="tw">대만</option>
              </select>
              <span class="caret" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </div>

          <!-- 시/도 -->
<div class="input-group">
    <label for="sido" class="input-label">시/도</label>
    <div class="field select-field">
      <select id="sido">
        <option value="" selected>시/도 선택하기</option>
        <option value="서울특별시">서울특별시</option>
        <option value="부산광역시">부산광역시</option>
        <option value="대구광역시">대구광역시</option>
        <option value="인천광역시">인천광역시</option>
        <option value="광주광역시">광주광역시</option>
        <option value="대전광역시">대전광역시</option>
        <option value="울산광역시">울산광역시</option>
        <option value="세종특별자치시">세종특별자치시</option>
        <option value="경기도">경기도</option>
        <option value="강원특별자치도">강원특별자치도</option>
        <option value="충청북도">충청북도</option>
        <option value="충청남도">충청남도</option>
        <option value="전북특별자치도">전북특별자치도</option>
        <option value="전라남도">전라남도</option>
        <option value="경상북도">경상북도</option>
        <option value="경상남도">경상남도</option>
        <option value="제주특별자치도">제주특별자치도</option>
      </select>
      <span class="caret" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
    </div>
  </div>
  

 
          <!-- 언어 -->
          <div class="input-group">
            <label for="lang" class="input-label">언어</label>
            <div class="field select-field">
              <select id="lang">
                <option value="" selected>언어선택하기</option>
                <option value="ko">한국어</option>
                <option value="en">영어</option>
                <option value="ja">일본어</option>
                <option value="zh">중국어</option>
                <option value="vi">베트남어</option>
                <option value="th">태국어</option>
                <option value="ru">러시아어</option>
              </select>
              <span class="caret" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </div>

          <!-- 번역 -->
          <div class="input-group">
            <label for="trans" class="input-label">번역</label>
            <div class="field select-field">
              <select id="trans">
                <option value="" selected>언어선택하기</option>
                <option value="ko">한국어</option>
                <option value="en">영어</option>
                <option value="ja">일본어</option>
                <option value="zh">중국어</option>
                <option value="vi">베트남어</option>
                <option value="th">태국어</option>
                <option value="ru">러시아어</option>
              </select>
              <span class="caret" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </div>

          <!-- 소개글 -->
          <div class="input-group">
            <label for="bio" class="input-label">소개글</label>
            <div class="textarea-field">
              <textarea id="bio" rows="3" placeholder='"13기 아기사자예요. 친구들과 언어교환하며 공부하고 싶어요! 📚"'></textarea>
            </div>
          </div>

          <!-- 버튼 -->
          <div class="btn-row">
            <button type="button" class="btn-primary" id="previewBtn">미리보기</button>
            <button type="button" class="btn-primary" id="submitBtn">완료</button>
          </div>
          
        </div>
      </section>
    </form>


    <script type="module">
  const BASE = "http://127.0.0.1:8000";   // 장고 서버 주소
  const PROFILE_URL = `${BASE}/users/profile/`;
  const CSRF_URL    = `${BASE}/users/csrf/`;
  const GOOGLE_LOGIN_URL = `${BASE}/users/google/login/`;

  // select의 라벨 텍스트 얻기
  const optText = (sel) => (sel.options[sel.selectedIndex] || {}).text || '';

  // --- CSRF 유틸 ---
  let CSRF_TOKEN = null;

  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const p = v.split(`; ${name}=`);
    if (p.length === 2) return p.pop().split(";").shift();
  }

  // CSRF 토큰을 JSON({csrfToken})로 받되, 실패하면 쿠키로 폴백
  async function ensureCsrf() {
    if (CSRF_TOKEN) return CSRF_TOKEN;
    try {
      const res = await fetch(CSRF_URL, { credentials: "include" });
      let token = "";
      try {
        const data = await res.json();
        token = data?.csrfToken || "";
      } catch {
        // JSON 아닐 수 있음 → 쿠키 폴백
      }
      CSRF_TOKEN = token || getCookie("csrftoken") || "";
    } catch (e) {
      console.warn("CSRF fetch failed:", e);
      CSRF_TOKEN = getCookie("csrftoken") || "";
    }
    return CSRF_TOKEN;
  }

  // --- 미리보기용 데이터 수집 ---
  function collectPreviewData() {
    const countrySel = document.getElementById('country');
    const langSel    = document.getElementById('lang');
    const transSel   = document.getElementById('trans');

    return {
      real_name: document.getElementById('real_name').value.trim(),
      age: document.getElementById('age').value.trim(),
      nationality: countrySel.value,
      nationality_label: optText(countrySel),
      city: document.getElementById('sido').value.trim(),
      service_language: langSel.value,
      service_language_label: optText(langSel),
      translation_category: transSel.value,
      translation_category_label: optText(transSel),
      introduction: document.getElementById('bio').value.trim(),
      google_verified: (document.querySelector('.badge-img')?.style.display || '') !== 'none'
    };
  }

  // --- 프로필 불러오기 ---
  async function loadProfile() {
    const res = await fetch(PROFILE_URL, { credentials: "include" });
    if (!res.ok) {
      console.warn("프로필 불러오기 실패:", await res.text());
      return;
    }
    const me = await res.json();

    document.getElementById("real_name").value = me.real_name || "";
    document.getElementById("age").value       = me.age || "";
    document.getElementById("country").value   = me.nationality || "";
    document.getElementById("sido").value      = me.city || "";
    document.getElementById("lang").value      = me.service_language || "";
    document.getElementById("trans").value     = me.translation_category || "";
    document.getElementById("bio").value       = me.introduction || "";

    document.querySelector(".badge-img").style.display = me.google_verified ? "block" : "none";
  }

  // --- 저장하기(성공=true/실패=false 반환만) ---
  async function saveProfile() {
    await ensureCsrf();
    const body = {
      real_name: document.getElementById("real_name").value || "",
      age: String(document.getElementById("age").value || ""),
      nationality: document.getElementById("country").value || null,
      city: document.getElementById("sido").value || "",
      service_language: document.getElementById("lang").value || null,
      translation_category: document.getElementById("trans").value || null,
      introduction: document.getElementById("bio").value || "",
    };

    try {
      const res = await fetch(PROFILE_URL, {
        method: "PUT",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRF_TOKEN || "",
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const msg = await res.text();
        alert("저장 실패: " + msg);
        return false;
      }

      // (선택) 캐시 갱신
      const draft = collectPreviewData();
      sessionStorage.setItem("preview_profile", JSON.stringify(draft));
      localStorage.setItem("profile_cache", JSON.stringify(draft));

      return true;
    } catch (e) {
      console.error(e);
      alert("네트워크 오류로 저장에 실패했습니다.");
      return false;
    }
  }

  // --- 이벤트 바인딩 ---
  // 미리보기: 값 저장 → 이동
  document.getElementById("previewBtn").addEventListener("click", () => {
    const draft = collectPreviewData();
    sessionStorage.setItem("preview_profile", JSON.stringify(draft));
    window.location.href = "pre.html";
  });

  // 완료: 저장 성공 시 홈으로 이동
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const ok = await saveProfile();
    if (ok) window.location.href = "../home/home.html";
  });

  // 구글 연결
  document.getElementById("googleConnectBtn").addEventListener("click", async () => {
    try {
      await ensureCsrf();
      const res = await fetch(GOOGLE_LOGIN_URL, { credentials: "include" });
      if (res.status === 401) {
        alert("로그인이 필요합니다. 먼저 로그인해 주세요.");
        return;
      }
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        alert(data.detail || "구글 인증 URL 생성에 실패했습니다.");
      }
    } catch (e) {
      console.error(e);
      alert("구글 인증 처리 중 오류가 발생했습니다.");
    }
  });

  // --- 초기화 ---
  await ensureCsrf();
  await loadProfile();
</script>

      
  </main>
  
</body>
</html>
