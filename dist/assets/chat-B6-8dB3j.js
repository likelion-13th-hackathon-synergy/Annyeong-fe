import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as b,A as N,D as q}from"./auth-CgfX5zSn.js";import{i as F,s as U}from"./i18n-DcpoQoQT.js";const d=document.getElementById("chat-list"),i=document.querySelector(".dropdown"),u=i?.querySelector(".selected-menu-text"),I=i?.querySelector(".selected-space"),v=document.getElementById("arrow"),O=Array.from(i?.querySelectorAll(".sub-menu li")||[]),B=i?.querySelectorAll(".sub-menu a")||[],P={1:"서포터즈",2:"구인구직",3:"통역",4:"언어교환",5:"연애/데이팅"};let h=(document.querySelector(".dropdown .selected-menu-text")?.textContent||"전체").trim(),r=[];window.__ME__=null;async function j(){const e=await fetch("/users/profile/",{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!e.ok)throw new Error(String(e.status));return e.json()}async function W(){try{const t=await j();return window.__ME__=t,!0}catch{const t=location.pathname+location.search;return location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(t)}`),!1}}const S=t=>t==null?"":String(t);function G(t){return t?/^https?:\/\//i.test(t)?t:t.startsWith("/")?`${t}`:t:q}function R(t,e=new Date){if(!t)return"";const n=new Date(t);if(isNaN(n.getTime()))return"";const a=s=>Date.UTC(s.getFullYear(),s.getMonth(),s.getDate()),o=a(e),c=a(n),l=Math.round((o-c)/864e5);if(l===0){const s=n.getHours(),w=String(n.getMinutes()).padStart(2,"0"),_=s>=12?"오후":"오전",y=s%12===0?12:s%12;return`${_} ${y}:${w}`}return l===1?"어제":n.getFullYear()===e.getFullYear()?`${n.getMonth()+1}월 ${n.getDate()}일`:`${n.getFullYear()}년`}function L(t){return t.slice().sort((e,n)=>{const a=new Date(e.updatedAt||0).getTime();return new Date(n.updatedAt||0).getTime()-a})}function Y(t,e){return t.id===e.id&&t.last===e.last&&t.updatedAt===e.updatedAt&&Number(t.unread||0)===Number(e.unread||0)}async function T(){const t=await b("/api/chat/chatrooms/",{method:"GET",headers:{"Content-Type":"application/json"}},N);if(t.status===401||t.status===403)throw new Error("로그인이 필요합니다.");if(!t.ok){const n=await t.text().catch(()=>"");throw new Error(`채팅방 목록 오류: ${t.status} ${n}`)}const e=await t.json();if(!Array.isArray(e))throw new Error("올바르지 않은 응답 형식입니다.");return e}function x(t=[]){return t.map(e=>{const n=e.other_participant||{},a=e.last_message||{},o=S(n.username||n.real_name||"알 수 없음"),c=P[e.chat_mode]||"기타",l=a?.image?"이미지를 보냈습니다.":S(a?.translated_content||a?.content||""),s=e.updated_at||a.created_at||null,w=R(s),_=Number(e.unread_count||0),y=n.profile_image||e.requester?.profile_image||e.receiver?.profile_image||"",k=G(y);return{id:e.id,name:o,mode:c,last:l,time:w,unread:_,profile:k,updatedAt:s}})}function p(t){d&&(d.innerHTML=t.map(e=>`
      <article class="tile" data-id="${e.id}" data-name="${encodeURIComponent(e.name)}">
        <div class="profile">
          <img src="${e.profile}" alt="${e.name} 프로필" class="profile-img">
        </div>
        <div class="chat-info">
          <div class="chat-header">
            <p>
              <span class="name">${e.name}</span>
              <div class="chat-mode-border">
                <span class="chat-mode-text">${e.mode}</span>
              </div>
            </p>
          </div>
          <div class="chat-message">${e.last}</div>
        </div>
        <div class="chat-info2">
          <span class="time">${e.time}</span>
          ${e.unread?`<span class="badge">${e.unread}</span>`:""}
        </div>
      </article>`).join(""),d.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.id,a=e.dataset.name;location.href=`../chat/chat-room.html?roomId=${n}&name=${a}`})}))}function g(t){return!t||t==="전체"?r:r.filter(e=>(e.mode||"").trim()===t.trim())}function $(){if(!u)return;const t=u.textContent.trim();O.forEach(e=>{const n=e.textContent.trim();e.style.display=n===t?"none":""})}function z(t){h=(t||"").trim(),p(g(h)),$(),D()}I?.addEventListener("click",t=>{t.stopPropagation(),i?.classList.toggle("show"),v?.classList.toggle("arrow")});B.forEach(t=>{t.addEventListener("click",e=>{if(e.preventDefault(),!u)return;const n=t.textContent.trim();n!==u.textContent.trim()&&(u.textContent=n,z(n)),i?.classList.remove("show"),v?.classList.remove("arrow")})});document.addEventListener("click",t=>{i?.contains(t.target)||(i?.classList.remove("show"),v?.classList.remove("arrow"))});const H=location.origin,V=H.replace(/^http/i,"ws"),m=new Map,E=new Map;function J(t){return`${V}/ws/chat/${t}/`}function K(t){return t?.type==="chat.image"||!!t?.image||typeof t?.image_url=="string"?"이미지를 보냈습니다.":String(t?.translated_content||t?.content||"")}function A(t,e){const n=r.findIndex(l=>Number(l.id)===Number(t));if(n<0)return;const a=r[n],o=e?.created_at||new Date().toISOString();a.updatedAt=o,a.time=R(o),a.last=K(e);const c=e?.sender?.username??e?.sender;c!=null&&window.__ME__?.username!=null&&String(c)!==String(window.__ME__?.username)&&(a.unread=Number(a.unread||0)+1),r=L(r),p(g(h))}function C(t){if(m.has(t))return;let e;try{e=new WebSocket(J(t))}catch{M(t);return}m.set(t,e),e.onopen=()=>E.set(t,0),e.onclose=()=>{m.delete(t),M(t)},e.onerror=()=>{},e.onmessage=n=>{if(!n.data)return;let a;try{a=JSON.parse(n.data)}catch{return}const o=a?.type;if(o==="message"||o==="chat.message"||o==="chat.image"){A(t,a);return}(typeof a.message<"u"||typeof a.image<"u")&&A(t,{content:a.message,image:a.image,translated_content:a.translated_content,created_at:a.timestamp,sender:{username:String(a.sender)}})}}function M(t){const e=Math.min((E.get(t)||0)+1,5);E.set(t,e);const n=Math.min(1e3*2**(e-1),1e4);setTimeout(()=>C(t),n)}function D(){r.forEach(t=>C(t.id))}window.addEventListener("beforeunload",()=>{m.forEach(t=>{try{t.close()}catch{}}),m.clear(),f&&(clearInterval(f),f=null)});let f=null;async function Q(){try{const t=await T(),e=x(t),n=L(e);(n.length!==r.length||n.some((o,c)=>!Y(o,r[c])))&&(r=n,p(g(h)),$())}catch(t){console.warn("[poll] rooms fetch failed",t)}}document.addEventListener("DOMContentLoaded",async()=>{if(document.querySelector(".main-logo-btn")?.addEventListener("click",()=>{location.href="../home/home.html"}),!!await W())try{const n=await T();r=L(x(n)),p(g(h)),$(),D(),f||(f=setInterval(Q,1e3))}catch(n){console.error(n),d&&(d.innerHTML=`<p class="error">채팅방 목록을 불러오지 못했습니다. ${n?.message||""}</p>`)}});F();window.addEventListener("storage",t=>{t.key==="preferredLang"&&t.newValue&&U(t.newValue,{persist:!1})});
