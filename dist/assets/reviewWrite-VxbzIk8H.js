import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as f,A as w}from"./auth-CgfX5zSn.js";import{i as y,s as E}from"./i18n-DcpoQoQT.js";const u=new URLSearchParams(location.search),a=Number(u.get("roomId"));u.get("userId");const d=decodeURIComponent(u.get("name")||""),I=document.querySelectorAll("#options .opt"),g=document.querySelector(".selCounter"),m=document.getElementById("review-send-btn"),v=5,c=new Set;async function S(){const t=await fetch("/users/profile/",{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(String(t.status));return t.json()}async function L(){try{const e=await S();return window.__ME__=e,!0}catch{const e=location.pathname+location.search;return location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(e)}`),!1}}function R(e){const t=document.querySelector("#review-w-title .strong-text");t&&(t.textContent=`‘ ${e}’ `)}const _={1:"이야기를 잘 들어줘요",2:"유머 감각이 뛰어나요",3:"대화가 재미있어요",4:"긍정적인 마인드예요",5:"친근하고 따뜻해요",6:"배려심이 깊어요",7:"지식이 풍부해요",8:"호기심이 많아요",9:"이해심이 많아요",10:"정직하고 솔직해요",11:"적극적이고 활발해요",12:"신뢰할 수 있어요"};function p(){g&&(g.textContent=String(c.size)),m&&(m.disabled=c.size===0)}I.forEach(e=>{e.addEventListener("click",()=>{const t=Number(e.dataset.id),n=!c.has(t);if(n&&c.size>=v){e.animate([{transform:"translateX(0)"},{transform:"translateX(-4px)"},{transform:"translateX(4px)"},{transform:"translateX(0)"}],{duration:200});return}n?(c.add(t),e.dataset.checked="true"):(c.delete(t),e.dataset.checked="false"),p()})});function l({userId:e,roomId:t,name:n}){const o=new URL("../review/review-view.html",location.href);o.searchParams.set("user_id",String(e)),t!=null&&o.searchParams.set("roomId",String(t)),n&&o.searchParams.set("name",n),location.href=o.toString()}async function A(){try{if(!Number.isFinite(a)||a<=0){alert("유효하지 않은 접근입니다. (roomId 누락)"),history.length>1?history.back():location.href="../home/home.html";return}if(!await L())return;const t=await f(`/reviews/can-write/${a}/`,{method:"GET"},w);if(t.status===401||t.status===403){const s=location.pathname+location.search;location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(s)}`);return}if(!t.ok){const s=await t.text().catch(()=>"");throw new Error(`사전 조회 실패: ${t.status} ${s}`)}const n=await t.json(),o=d&&d.trim()||n.other_user_name||"상대";if(R(o),n.already_reviewed){alert("이미 후기를 작성했습니다. 리뷰보기로 이동합니다."),l({userId:n.other_user_id,roomId:a,name:n.other_user_name||o});return}m?.addEventListener("click",async()=>{try{if(c.size===0){alert("최소 1개 이상 선택해 주세요.");return}const s=Array.from(c).filter(r=>_[r]).map(r=>_[r]),i=await f(`/reviews/create/${a}/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({personalities:s})},w);if(i.status===401||i.status===403){const r=location.pathname+location.search;location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(r)}`);return}if(i.status===400){const r=await i.json().catch(()=>({}));if(r?.already_reviewed){alert("이미 후기를 작성하셨습니다. 리뷰보기로 이동합니다."),l({userId:n.other_user_id,roomId:a,name:n.other_user_name||o});return}throw new Error(r?.detail||"요청이 올바르지 않습니다.")}if(!i.ok){const r=await i.text().catch(()=>"");throw new Error(`리뷰 저장 실패: ${i.status} ${r}`)}const h=await i.json().catch(()=>({}));alert("후기가 저장되었습니다."),l({userId:h.reviewed_user_id||n.other_user_id,roomId:a,name:h.reviewed_user_name||n.other_user_name||o})}catch(s){console.error(s),alert(s?.message||"후기 저장 중 오류가 발생했습니다.")}}),p()}catch(e){console.error(e),alert("페이지 로드 중 오류가 발생했습니다.")}}document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".back-btn");if(!e)return;const t=`../chat/chat-room.html?roomId=${a}&name=${encodeURIComponent(d||"")}`;try{sessionStorage.setItem("REVIEW_BACK_URL",t)}catch{}e.addEventListener("click",()=>{try{const n=sessionStorage.getItem("REVIEW_BACK_URL");if(n){sessionStorage.removeItem("REVIEW_BACK_URL"),location.href=n;return}}catch{}if(document.referrer&&!/review-view\.html/i.test(document.referrer)){location.href=document.referrer;return}if(a){location.href=t;return}location.href="../chat/chat-list.html"})});document.addEventListener("DOMContentLoaded",A);y();window.addEventListener("storage",e=>{e.key==="preferredLang"&&e.newValue&&E(e.newValue,{persist:!1})});
