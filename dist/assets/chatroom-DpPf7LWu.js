import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as f,A as h,D as ee}from"./auth-CgfX5zSn.js";import{i as te,s as ne}from"./i18n-DcpoQoQT.js";const u=e=>document.querySelector(e);function y(e=""){return e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function ae(e){try{return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return""}}function re(e){e&&(e.scrollTop=e.scrollHeight)}function se(e){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}const P=new URL(location.href).searchParams,c=Number(P.get("roomId")),T=decodeURIComponent(P.get("name")||"상대");let m=P.get("accepted")==="1",g=null;const L=new Set;let $=null,I=null,O=null;const B=u("#messages"),x=u("#msg-input"),Z=u("#send-btn"),b=u("#file-input"),K=u("#attach-btn"),d=u("#invite-banner"),ie=u("#btn-accept"),oe=u("#btn-decline"),ce=u("#chat-wrapper"),q=u("#chat-title"),W=u("#invite-name"),F=document.getElementById("chat-menu-btn");async function le(){const t=await fetch("/users/profile/",{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(String(t.status));return t.json()}async function de(){try{const e=await le();return window.__ME__=e,!0}catch{const e=location.pathname+location.search;return location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(e)}`),!1}}function w(){return window.__ME__?.username||"me"}const me=new Set(["image/jpeg","image/png","image/webp","image/gif"]);function ue(e){return e?/^https?:\/\//i.test(e)?e:e.startsWith("/")?`${e}`:e:ee}function M(e){return e?/^https?:\/\//i.test(e)?e:e.startsWith("/")?`${e}`:e:""}function ge(){q&&(q.textContent=T),W&&(W.textContent=T)}function fe(e){if(!e)return!1;if(e.type&&me.has(e.type))return!0;const t=(e.name||"").toLowerCase();return/\.(jpe?g|png|webp|gif)$/.test(t)}function he(e){const[t,n]=e.split(","),a=/data:(.*?);base64/.exec(t)?.[1]||"application/octet-stream",r=atob(n),s=r.length,o=new Uint8Array(s);for(let i=0;i<s;i++)o[i]=r.charCodeAt(i);return new Blob([o],{type:a})}function Y(e){try{window.dispatchEvent(new CustomEvent("chat:room-updated",{detail:{roomId:c,content:e.content||"",created_at:e.created_at||new Date().toISOString(),sender:{username:w()}}}))}catch{}}async function pe(e,{maxDim:t=1280,quality:n=.8}={}){const a=await new Promise((R,E)=>{const l=new Image;l.onload=()=>R(l),l.onerror=E,l.src=URL.createObjectURL(e)}),r=Math.min(1,t/Math.max(a.width,a.height)),s=Math.round(a.width*r),o=Math.round(a.height*r),i=document.createElement("canvas");return i.width=s,i.height=o,i.getContext("2d").drawImage(a,0,0,s,o),{dataUrl:i.toDataURL("image/jpeg",n),width:s,height:o,mime:"image/jpeg"}}const D=[],we=5e3;function X(){const e=Date.now();for(;D.length&&e-D[0].at>we;)D.shift()}function C(e){X();const t=(e||"").trim();return D.some(n=>n.content===t)}function ye(e){X(),D.push({content:(e||"").trim(),at:Date.now()})}let N=null;const ve=["일","월","화","수","목","금","토"],G=e=>String(e).padStart(2,"0"),_e=e=>`${e.getFullYear()}-${G(e.getMonth()+1)}-${G(e.getDate())}`;function Se(e){return`${e.getFullYear()}년 ${e.getMonth()+1}월 ${e.getDate()}일 ${ve[e.getDay()]}요일`}function Ee(e){const t=_e(e);if(t===N)return;N=t;const n=document.createElement("li");n.className="date-divider",n.innerHTML=`
    <span class="pill">
      <span class="cal">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
          <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v12a2
                   2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1Zm12
                   8H5v8a0 0 0 0 0 0 0h14a0 0 0 0 0 0 0v-8ZM19 6H5v2h14V6Z"/>
        </svg>
      </span>
      <span>${Se(e)}</span>
    </span>
  `,B.appendChild(n)}function v(e){[x,Z,K,b].forEach(t=>{t&&(t.disabled=!e)}),d&&(e?(d.hidden=!0,d.style.display="none",d.setAttribute("aria-hidden","true")):(d.hidden=!1,d.style.display="",d.removeAttribute("aria-hidden")))}function _({message:e,sender:t="unknown",timestamp:n,avatar:a,translatedHint:r,imageUrl:s}){const o=n?new Date(n):new Date;Ee(o);const i=t===w(),S=document.createElement("li");S.className=`msg ${i?"me":"other"}`;const H=i?"":`<img class="avatar" src="${y(ue(a))}" alt="${y(t)}" />`,R=i?"":`<div class="name">${y(t)}</div>`;let E="";if(s){const l=M(s);E=`
      <div class="bubble">
        <a class="img-link" href="${y(l)}" target="_blank" rel="noopener noreferrer">
          <img class="img-msg" src="${y(l)}" alt="image" />
        </a>
        <span class="tail">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="14" viewBox="0 0 13 14" fill="none">
            <path d="M1.63227 1.2761C5.91261 3.11151 10.0495 4.18948 11.8179 3C11.8179 3 10.6358 15.3683 9.0679 12.9342C7.56627 10.6029 4.29243 5.91811 1.38292 1.57308C1.27146 1.40664 1.44817 1.19716 1.63227 1.2761Z" fill="white" stroke="white"/>
          </svg>
        </span>
      </div>`}else{const l=String(e??""),j=r?String(r):"";E=`
      <div class="bubble" data-state="orig"
           data-original="${y(l)}"
           data-translated="${y(j)}">
        <div class="text">${y(l)}</div>
        <div class="actions"><button type="button" class="translate">번역보기</button></div>
        <span class="tail">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="14" viewBox="0 0 13 14" fill="none">
            <path d="M1.63227 1.2761C5.91261 3.11151 10.0495 4.18948 11.8179 3C11.8179 3 10.6358 15.3683 9.0679 12.9342C7.56627 10.6029 4.29243 5.91811 1.38292 1.57308C1.27146 1.40664 1.44817 1.19716 1.63227 1.2761Z" fill="white" stroke="white"/>
          </svg>
        </span>
      </div>`}if(S.innerHTML=`
    ${H}
    <div style="display:flex;flex-direction:column;gap:4px;max-width:80%;">
      ${R}
      ${E}
    </div>
    <div class="meta">${ae(o)}</div>
  `,!s){const l=S.querySelector(".bubble");l?.querySelector(".translate")?.addEventListener("click",async()=>$e(l))}return B.appendChild(S),re(ce),S}async function $e(e){if(!e)return;const t=e.querySelector(".text"),n=e.querySelector(".translate"),a=e.dataset.state||"orig",r=e.dataset.original??"";let s=e.dataset.translated??"";if(a==="orig"){if(!s)try{const o=await f("/api/chat/translate/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:r})},h);if(!o.ok)throw new Error;s=(await o.json())?.translated_text||"",e.dataset.translated=s}catch{return}t.textContent=s||r,e.dataset.state="translated",n&&(n.textContent="원문보기")}else t.textContent=r,e.dataset.state="orig",n&&(n.textContent="번역보기")}async function Ie(){try{const e=await f(`/api/chat/messages/?chatroom=${c}`,{method:"GET"},h);if(!e.ok)throw new Error("메시지 로드 실패");const t=await e.json();if(B.innerHTML="",L.clear(),N=null,t.forEach(n=>{const a=String(n.id??`${n.created_at}|${n.sender?.username}|${n.content||""}|${n.image||""}`);L.add(a),_({message:n.content,sender:n.sender?.username||"unknown",timestamp:n.created_at,avatar:n.sender?.profile_image,translatedHint:n.translated_content||"",imageUrl:n.image?M(n.image):null})}),t.length){const n=t[t.length-1];$=n.created_at||new Date().toISOString(),I=n.id??null}await f(`/api/chat/chatrooms/${c}/mark_read/`,{method:"POST"},h),!m&&t.length===0?v(!1):v(!0)}catch{}}async function De(e){const t=await f("/api/chat/chatrooms/",{method:"GET"},h);if(!t.ok)throw new Error("채팅방 목록 조회 실패");const n=await t.json(),a=Array.isArray(n)?n.find(i=>Number(i.id)===Number(e)):null;if(!a)return{exists:!1,is_active:!1,iAmRequester:!1,iAmReceiver:!1,room:null};const r=w(),s=a.requester?.username===r,o=a.receiver?.username===r;return{exists:!0,is_active:!!a.is_active,iAmRequester:s,iAmReceiver:o,room:a}}async function Le({text:e,fileOrBlob:t,filename:n}){const a=new FormData;a.append("chatroom",c),e&&a.append("content",e),t&&a.append("image",t,n||"image.jpg");const r=await f("/api/chat/upload-image/",{method:"POST",body:a},h);if(!r.ok)throw new Error("upload failed");return await r.json()}async function be(e){if(!m){A("대화를 수락하면 이미지를 보낼 수 있어요.");return}if(!fe(e)){A("이미지 파일만 업로드 가능합니다.");return}const{dataUrl:t}=await pe(e),n=he(t),a=_({sender:w(),timestamp:Date.now(),imageUrl:t});try{const r=await Le({fileOrBlob:n,filename:e.name}),s=M(r.image);Y({content:"",created_at:r?.created_at||new Date().toISOString()});const o=a.querySelector("img.img-msg"),i=a.querySelector("a.img-link");o&&s&&(o.src=s),i&&s&&(i.href=s)}catch{}}async function ke(e,t){const n=new FormData;n.append("chatroom",e),n.append("content",t);const a=await f("/api/chat/messages/",{method:"POST",body:n},h);if(!a.ok){const r=await a.text().catch(()=>"");throw new Error(`메시지 저장 실패: ${a.status} ${r}`)}return await a.json()}async function Te(e){const t={message:e,sender_id:window.__ME__?.id,translated_content:null};if(p&&U&&p.readyState===WebSocket.OPEN)try{p.send(JSON.stringify(t))}catch{}try{const n=await ke(c,e);Y({content:e,created_at:n?.created_at||new Date().toISOString()})}catch(n){console.error(n)}}function V(){const e=(x?.value||"").trim();if(!e)return;if(!m){A("대화를 수락하면 메시지를 보낼 수 있어요.");return}ye(e),_({message:e,sender:w(),timestamp:new Date().toISOString()});const t=`${new Date().toISOString()}|${w()}|${e}`;L.add(t),Te(e),x.value=""}let p=null,U=!1,k=0;const xe=location.origin,Ae=xe.replace(/^http/i,"ws"),Me=`${Ae}/ws/chat/${c}/`;function z(){try{p=new WebSocket(Me)}catch{J();return}p.onopen=()=>{U=!0,k=0,document.body.classList.add("ws-online")},p.onclose=()=>{U=!1,document.body.classList.remove("ws-online"),J()},p.onerror=()=>{},p.onmessage=e=>{if(!e.data)return;let t;try{t=JSON.parse(e.data)}catch{return}if(t.type==="message"||t.type==="chat.message"||t.type==="chat.image"){if(t.sender?.username&&t.sender.username===w()&&typeof t.content=="string"&&C(t.content))return;_({message:t.content,sender:t.sender?.username||"unknown",timestamp:t.created_at||new Date().toISOString(),avatar:t.sender?.profile_image,translatedHint:t.translated_content||"",imageUrl:t.image||null});return}if(typeof t.message<"u"||typeof t.image<"u"){const n=!!t.image,a=String(t.sender)===String(window.__ME__?.id);if(a&&!n&&typeof t.message=="string"&&C(t.message))return;_({message:n?"":t.message||"",sender:a?w():"other",timestamp:t.timestamp,avatar:null,translatedHint:t.translated_content||"",imageUrl:n?t.image:null})}}}function J(){k=Math.min(k+1,5);const e=Math.min(1e3*2**(k-1),1e4);setTimeout(z,e)}async function Re(){try{if((await f(`/api/chat/chatrooms/${c}/accept/`,{method:"POST"},h)).ok){m=!0,v(!0),await f(`/api/chat/chatrooms/${c}/mark_read/`,{method:"POST"},h);return}m=!0,v(!0)}catch{m=!0,v(!0)}}async function Oe(){try{alert("방이 삭제됩니다."),await f(`/api/chat/chatrooms/${c}/decline/`,{method:"POST"},h)}catch{}finally{try{const t="DECLINED_ROOM_IDS",n=new Set(JSON.parse(localStorage.getItem(t)||"[]"));n.add(Number(c)),localStorage.setItem(t,JSON.stringify([...n]))}catch{}const e=`../review/review-write.html?roomId=${c}&name=${encodeURIComponent(T)}`;location.href=e}}async function Q(){try{const e=await f(`/api/chat/messages/?chatroom=${c}`,{method:"GET"},h);if(!e.ok)return;const t=await e.json();if(!Array.isArray(t)||t.length===0)return;const n=t.filter(a=>I!=null&&a.id!=null?Number(a.id)>Number(I):$?new Date(a.created_at)>new Date($):!0);if(!n.length)return;n.sort((a,r)=>new Date(a.created_at)-new Date(r.created_at));for(const a of n){const r=String(a.id??`${a.created_at}|${a.sender?.username}|${a.content||""}|${a.image||""}`);L.has(r)||(L.add(r),a.sender?.username&&a.sender.username===w()&&typeof a.content=="string"&&C(a.content))||(_({message:a.content,sender:a.sender?.username||"unknown",timestamp:a.created_at,avatar:a.sender?.profile_image,translatedHint:a.translated_content||"",imageUrl:a.image?M(a.image):null}),$=a.created_at||$,I=a.id??I)}}catch{}}se(async()=>{if(!await de())return;ge(),F&&F.addEventListener("click",()=>{const n=new URLSearchParams({roomId:String(c),userId:String(O?.id||""),name:O?.name||T}).toString();location.href=`../review/review-write.html?${n}`});let t={exists:!1,is_active:!1,iAmRequester:!1,iAmReceiver:!1};try{t=await De(c),t?.room?.other_participant&&(O={id:t.room.other_participant.id,name:t.room.other_participant.username||t.room.other_participant.real_name||"상대"})}catch{}await Ie(),t.exists&&t.is_active?(m=!0,v(!0)):t.exists&&!t.is_active?(m=!1,v(!1),t.iAmRequester?(d.hidden=!0,d.style.display="none"):t.iAmReceiver&&(d.hidden=!1,d.style.display="")):(m=!1,v(!1)),Z?.addEventListener("click",V),x?.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),V())}),K?.addEventListener("click",()=>{if(!m){A("대화를 수락하면 이미지를 보낼 수 있어요.");return}b?.disabled||b?.click()}),b?.addEventListener("change",async n=>{if(!m){n.target.value="";return}const a=n.target.files?.[0];a&&(await be(a),n.target.value="")}),ie?.addEventListener("click",Re),oe?.addEventListener("click",Oe),z(),g||(g=setInterval(Q,1500))});function A(e){_({message:e,sender:"system",timestamp:Date.now()})}window.addEventListener("beforeunload",()=>{g&&(clearInterval(g),g=null);try{p?.close()}catch{}});document.addEventListener("visibilitychange",()=>{document.hidden?g&&(clearInterval(g),g=null):g||(g=setInterval(Q,1500))});document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".back-btn")?.addEventListener("click",()=>{window.location.href="../chat/chat-list.html"})});te();window.addEventListener("storage",e=>{e.key==="preferredLang"&&e.newValue&&ne(e.newValue,{persist:!1})});
