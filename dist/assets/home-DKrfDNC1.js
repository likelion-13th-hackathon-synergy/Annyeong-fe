import"./modulepreload-polyfill-B5Qt9EMX.js";import"./i18n-DcpoQoQT.js";const p="",w=e=>document.querySelector(e),d=(e,t)=>{const n=w(e);return n||console.error(`❌ 필수 요소 누락: ${t} selector="${e}"`),n};function y(e){const t=d("#card-container","카드 컨테이너");t&&(t.innerHTML=`<div style="padding:16px;line-height:1.5">${e}</div>`)}async function L(){try{if(!(await fetch(`${p}/users/profile/`,{method:"GET",credentials:"include",headers:{Accept:"application/json"}})).ok)throw 0;return!0}catch{const e=location.pathname+location.search;return location.replace(`/Annyeong-fe/login/login.html?next=${encodeURIComponent(e)}`),!1}}function h(e){const t=document.cookie.match(new RegExp("(^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[2]):null}async function v(){let e=h("csrftoken");return e||(await fetch(`${p}/users/csrf/`,{method:"GET",credentials:"include"}),e=h("csrftoken")),e}function x(e){return!["GET","HEAD","OPTIONS","TRACE"].includes(String(e).toUpperCase())}async function u(e,t={}){const n=(t.method||"GET").toUpperCase(),o=new Headers(t.headers||{});if(o.has("Accept")||o.set("Accept","application/json"),x(n)){const a=h("csrftoken")||await v();!(t.body instanceof FormData)&&!o.has("Content-Type")&&o.set("Content-Type","application/json"),o.set("X-CSRFToken",a)}return fetch(`${p}${e}`,{...t,method:n,headers:o,credentials:"include"})}async function C(){const e=await u("/api/match/preference/");if(!e.ok)throw new Error(`mode 조회 실패: ${e.status}`);return e.json()}async function T(e){const t=await u("/api/match/preference/",{method:"PUT",body:JSON.stringify({mode:e})});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n?.mode?.[0]||n?.detail||`mode 저장 실패: ${t.status}`)}return t.json()}async function $(){const e=await u("/api/match/random-user/");if(e.status===400){const n=await e.json().catch(()=>({})),o=new Error(n?.detail||"모드가 설정되어 있지 않습니다.");throw o.code=400,o}if(!e.ok)throw new Error(`추천 실패: ${e.status}`);const t=await e.json();return t?.detail?null:t}async function E(e){const t=await u(`/api/match/like/${e}/`,{method:"POST"});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n?.detail||`호감 실패: ${t.status}`)}return t.json()}async function b(e){const t=await u(`/api/match/dislike/${e}/`,{method:"POST"});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n?.detail||`생략 실패: ${t.status}`)}return t.json()}let l=null;function j(){const e=w(".app-wrapper");let t=e?.querySelector("#swipe-overlay");return!t&&e&&(t=document.createElement("div"),t.id="swipe-overlay",Object.assign(t.style,{position:"absolute",inset:"0",zIndex:"100",pointerEvents:"none",opacity:"0",transition:"opacity 0.1s ease-in-out",backgroundRepeat:"no-repeat",backgroundSize:"70px 100%"}),e.appendChild(t)),t}function S(e,t){const n=t.querySelector(".profile-image"),o=t.querySelector(".profile-name"),a=t.querySelector(".profile-location"),i=t.querySelector(".profile-description"),c=t.querySelector(".badge");if(n&&(n.src=e.profile_image||"../assets/images/home/type-1.svg"),o&&(o.innerHTML=`${(e.real_name||e.username)??""}${e.age!=null?" "+e.age:""} <span class="badge"></span>`),a&&(a.textContent=[e.city,e.nationality].filter(Boolean).join(" | ")||"위치 정보 없음"),i&&(i.textContent=e.introduction||"소개글 없음."),c&&(c.innerHTML="",e.google_verified===!0||e.google_verified===1||e.google_verified==="1")){const r=document.createElement("img");r.src="../assets/images/home/check.svg",r.alt="인증",r.className="google-badge",c.appendChild(r)}}function M(e){if(!e)return;const t=j();let n=0,o=0,a=!1;function i(s){o=s-n,e.style.transform=`translateX(${o}px)`,t&&(t.style.opacity=String(Math.min(Math.abs(o)/50,1)),o>0?(t.style.backgroundImage="linear-gradient(to right, rgba(0,255,0,0) 0px, rgba(0,255,0,0.8))",t.style.backgroundPosition="right"):(t.style.backgroundImage="linear-gradient(to left, rgba(255,0,0,0) 0px, rgba(255,0,0,0.8))",t.style.backgroundPosition="left"))}async function c(){if(a=!1,Math.abs(o)>100){e.style.transition="transform .3s ease",e.style.transform=`translateX(${o>0?1e3:-1e3}px)`;try{o>0&&l?.id?await E(l.id):o<0&&l?.id&&await b(l.id)}catch(s){console.warn("스와이프 액션 실패:",s?.message||s)}setTimeout(()=>{t&&(t.style.opacity="0"),f()},280)}else e.style.transition="transform .3s ease",e.style.transform="translateX(0)",setTimeout(()=>{e.style.transition="",t&&(t.style.opacity="0")},300)}e.addEventListener("mousedown",s=>{n=s.clientX,a=!0,e.style.transition=""}),e.addEventListener("mousemove",s=>{a&&i(s.clientX)}),e.addEventListener("mouseup",()=>a&&c()),e.addEventListener("mouseleave",()=>a&&c()),e.addEventListener("touchstart",s=>{const r=s.touches?.[0];r&&(n=r.clientX,a=!0,e.style.transition="")},{passive:!0}),e.addEventListener("touchmove",s=>{if(!a)return;const r=s.touches?.[0];r&&i(r.clientX)},{passive:!0}),e.addEventListener("touchend",()=>a&&c())}const A={1:"구인구직",2:"통역",3:"버디",4:"연애/데이팅",5:"서포터즈"},P={구인구직:1,통역:2,버디:3,"연애/데이팅":4,서포터즈:5};let k=null;async function _(){const e=d(".dropdown-menu","드롭다운 메뉴"),t=d(".selected-text","선택 텍스트"),n=d(".dropdown-arrow","드롭다운 화살표"),o=document.querySelectorAll(".sub-menu a");if(!e||!t||!n)return;function a(){n.src=e.classList.contains("active")?"../assets/images/home/dropdown-after.svg":"../assets/images/home/dropdown-before.svg"}try{const i=await C(),c=A[Number(i?.mode)]||"서포터즈";t.textContent=c,o.forEach(s=>{s.parentElement.style.display=s.textContent.trim()===c?"none":"block"})}catch{t.textContent="서포터즈",o.forEach(i=>{i.parentElement.style.display=i.textContent.trim()==="서포터즈"?"none":"block"})}e.addEventListener("click",i=>{i.target.closest(".sub-menu")||(e.classList.toggle("active"),a())}),document.addEventListener("click",i=>{!e.contains(i.target)&&e.classList.contains("active")&&(e.classList.remove("active"),a())}),o.forEach(i=>{i.addEventListener("click",async c=>{c.preventDefault();const s=i.textContent.trim(),r=P[s];if(r)try{await T(r),t.textContent=s,o.forEach(m=>{m.parentElement.style.display=m.textContent.trim()===s?"none":"block"}),e.classList.remove("active"),a(),await f()}catch(m){alert(m?.message||"매칭 모드 저장 실패")}})}),k={open:()=>{e.classList.add("active"),a()}}}async function f(){const e=d("#card-container","카드 컨테이너");if(e){e.innerHTML='<div style="padding:16px">불러오는 중...</div>';try{const t=await $();if(!t){y("추천할 사용자가 없습니다."),l=null,g(!0);return}l=t,e.innerHTML=`
      <div class="card-wrapper" style="touch-action: pan-y;">
        <div class="image-container">
          <img class="profile-image type" src="${t.profile_image||"../assets/images/home/type-1.svg"}" alt="">
          <div class="card">
            <h1 class="profile-name">${(t.real_name||t.username)??""}${t.age!=null?" "+t.age:""} <span class="badge"></span></h1>
            <p class="profile-location">${[t.city,t.nationality].filter(Boolean).join(" | ")||"위치 정보 없음"}</p>
            <p class="profile-description">${t.introduction||"소개글 없음."}</p>
          </div>
          <a href="../review/review-view.html"><img src="../assets/images/home/review.svg" class="review" alt="리뷰 이동"></a>
        </div>
      </div>
    `;const n=e.querySelector(".card-wrapper");S(t,n),M(n),g(!1)}catch(t){t?.code===400||/모드가 설정되어/.test(t?.message||"")?(y("매칭 모드가 설정되어 있지 않습니다.<br>상단 드롭다운에서 모드를 선택해 주세요."),k?.open?.()):y("카드를 불러오지 못했습니다. 잠시 후 다시 시도해 주세요."),l=null,g(!0)}}}function g(e){const t=d("#yes-button","예 버튼"),n=d("#no-button","아니오 버튼");t&&(t.disabled=e),n&&(n.disabled=e)}async function O(){if(l?.id){try{await E(l.id)}catch(e){alert(e?.message||"호감 표시 실패")}await f()}}async function X(){if(l?.id){try{await b(l.id)}catch(e){alert(e?.message||"생략 실패")}await f()}}document.addEventListener("DOMContentLoaded",async()=>{if(!await L())return;await v();const t=d("#yes-button","예 버튼"),n=d("#no-button","아니오 버튼");t?.addEventListener("click",O),n?.addEventListener("click",X),g(!0),await _(),await f()});
